---
title: "Attendance Report"
output:
  pdf_document: 
    keep_tex: yes
  keep_md: yes
params:
  d: !r Sys.Date()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pdftools)
library(magrittr)
library(lubridate)
library(tibble)
library(dplyr)
library(ggplot2)
library(here)
library(kableExtra)
library(tidyr)
library(stringr)


# Set flag for identifying rows with desired data.
a0 <- "A00000"

# Set flag for holiday because CAMS is too stupid to exclude holidays from reports.
# MLK Day
holiday <- "2020-01-20"

# Initialize empty data frame.
df <- data.frame(Student=character(), 
                 Presence=character(), 
                 Date=character(), 
                 stringsAsFactors=FALSE) 

# Get raw attendance text, a list of lists.
att <- pdf_text(here("Attendance Report.pdf")) %>% strsplit(split = "\n")

# Set header.
header <- att[[1]][2]

# Iterate over each page, over each line.
for (i in 1:length(att)) {
  page <- att[[i]]
  for (j in 1:length(page)) {
    line <- page[[j]]
    linelist <- strsplit(line, "\\s+")[[1]]
    n <- length(linelist)
    if (!is.na(substr(linelist[5], 1, 6))){
      if (substr(linelist[n - 2], 1, 6) == a0) {
        if (linelist[6] == "Left") {
          new_row <- c(paste(linelist[2:3], collapse = " "), 
                       paste(linelist[(n - 2):(n - 1)], collapse = " "),
                       linelist[n])
        } else {
          new_row <- c(paste(linelist[2:3], collapse = " "), linelist[(n - 1):(n)])
        }
        df[nrow(df)+1,] <- new_row
      }
    }
  }
}

df$Student <- str_to_title(df$Student)
df$Date <- mdy(df$Date)
# Exclude holidays.
df %>% filter(Date != holiday) -> df

class_days_n <- length(unique(df$Date))
```

## `r header`

#### This document was created on `r params$d`.

Class has met `r class_days_n` times so far. 

## Course attendance by date.

```{r by_date, echo=FALSE, fig.height=3}
df %>% group_by(Date) %>% 
  count(name = "total") -> date_df
df %>% group_by(Date) %>% 
  filter(Presence == "Present" | Presence == "Late" | Presence == "Left Early") %>% 
  count(name = "in_class") -> date_p_df
date_df %>% add_column(in_class = date_p_df$in_class) -> date_df
date_df %>% mutate(percent = round(in_class / total * 100)) -> date_df

kable(date_df %>% select(Date, in_class, total, percent))

ggplot(date_df, aes(factor(Date), percent, group = 1)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5)) +
  xlab("Date") +
  ylim(0, 100)
```


```{r by_student, echo=FALSE}
df %>% filter(Date == max(Date)) -> most_recent_day_df
cur_enr_students <- most_recent_day_df$Student
cur_enr_df <- df %>% filter(Student %in% cur_enr_students)
cur_enr_df %>% 
  group_by(Student) %>% 
  filter(Presence == "Present" | Presence == "Late" | Presence == "Left Early") %>% 
  count(name = "in_class", .drop = FALSE) -> inc_table
# .drop = FALSE not working as expected.  Students with perfect attendance
# not being accounted for with 0 absences.
cur_enr_df %>%
  group_by(Student) %>%
  filter(Presence == "Absent") %>%
  count(name = "absent", .drop = FALSE) -> abs_table

att_table <-  merge(inc_table, abs_table, by = "Student", all = TRUE) %>% replace_na(replace = list(in_class = 0, absent = 0))

perfect <- att_table %>% filter(in_class == max(att_table$in_class))
# poor <- att_table %>% filter(in_class %in% min(att_table$in_class):(min(att_table$in_class) + 2))
no_show <- att_table %>% filter(in_class == 0)

dates <- cur_enr_df$Date %>% unique()
last_two_days <- dates[(length(dates) - 1):length(dates)]
missed_last_two_days <- cur_enr_df %>% filter(Date %in% last_two_days & Presence == "Absent") %>% group_by(Student) %>% count() %>% filter(n == 2) # %>% select(Student)
```

## Course attendance by student.

### Students with perfect attendance:

`r paste(perfect$Student, collapse = "; ")`

### No shows:

`r paste(no_show$Student, collapse = ";  ")`

### Students who missed the last two class days:

`r paste(missed_last_two_days$Student, collapse = ";  ")`

<!-- \pagebreak -->

## `r header`

## Course attendance by student.


```{r table, echo=FALSE}
# halfway <- ceiling(nrow(att_table)/2)
# kable(list(
#   att_table[1:halfway,],
#   att_table[(halfway + 1):nrow(att_table),]
#   ),
#   booktabs = TRUE, valign = 't'#, align = NULL
#   ) # %>% kable_styling(latex_options = "hold_position")
kable(att_table, booktabs = TRUE, valign = 't', align = NULL)
```
