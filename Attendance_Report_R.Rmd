---
title: "Attendance Report"
output:
  pdf_document: 
    keep_tex: yes
  keep_md: yes
params:
  d: !r Sys.Date()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pdftools)
library(magrittr)
library(lubridate)
library(tibble)
library(dplyr)
library(ggplot2)
library(here)
library(kableExtra)
library(tidyr)
library(stringr)
library(stringi)

# Set flag for identifying rows with desired data.
a0 <- "A00000"

# Set flag for holiday because CAMS is too stupid to exclude holidays from reports.
# MLK Day
holiday <- "2020-01-20"

# Initialize empty data frame.
df <- data.frame(Student=character(), 
                 Presence=character(), 
                 Date=character(), 
                 stringsAsFactors=FALSE) 

# Get raw attendance text, a list of lists.
pdf_text(here("Attendance Report.pdf")) %>% strsplit(split = "\n") -> raw_data

# Get header.
header <- raw_data[[1]][2]

# Iterate over each page, over each line.
for (i in 1:length(raw_data)) {
  page <- raw_data[[i]]
  for (j in 1:length(page)) {
    line <- page[[j]]
    # Strip each line into a list, and store its length.
    linelist <- strsplit(line, "\\s+")[[1]]
    n <- length(linelist)
    
    # Check if line contains student data by
    # checking whether that flagged string is in
    # any word in the list.
    if (TRUE %in%  stri_detect_fixed(linelist, a0)) {
      # Check if student Left Early, since "Left Early"
      # is two words.
      if (TRUE %in%  stri_detect_fixed(linelist, "Left")) {
        # Save to new_row the student's name, presence status, and date.
        new_row <- c(paste(linelist[2:3], collapse = " "), # name (Student)
             paste(linelist[(n - 2):(n - 1)], collapse = " "), # Presence
             linelist[n]) # Date
      } else {
        # again, save name, presence and date to new_row.
        new_row <- c(paste(linelist[2:3], collapse = " "), linelist[(n - 1):(n)])
      }
      # Add new_row to dataframe.
      df[nrow(df)+1,] <- new_row
    }
  }
}

# Correct Student name capitalization.
df$Student <- str_to_title(df$Student)
# Set the date string as a Date object.
df$Date <- mdy(df$Date)
# Exclude holidays.
df %>% filter(Date != holiday) -> df
# Get number of class days.
class_days_n <- length(unique(df$Date))
```

## `r header`

#### This document was created on `r params$d`.

Class has met `r class_days_n` times so far. 

## Course attendance by date.

```{r by_date, echo=FALSE, fig.height=3}
# Get attendance info by date.


df %>% group_by(Date) %>% 
  count(name = "Total") -> date_df
df %>% group_by(Date) %>% 
  filter(Presence == "Present" | Presence == "Late" | Presence == "Left Early") %>% 
  count(name = "In_Class") -> date_p_df
date_df %>% add_column(In_Class = date_p_df$In_Class) -> date_df
date_df %>% mutate(Percent = round(In_Class / Total * 100)) -> date_df


ggplot(date_df, aes(factor(Date), Percent, group = 1)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5)) +
  xlab("Date") +
  ylim(0, 100)
```


```{r by_student, echo=FALSE}
df %>% filter(Date == max(Date)) -> most_recent_day_df
cur_enr_students <- most_recent_day_df$Student
cur_enr_df <- df %>% filter(Student %in% cur_enr_students)
cur_enr_df %>% 
  group_by(Student) %>% 
  filter(Presence == "Present" | Presence == "Late" | Presence == "Left Early") %>% 
  count(name = "In_Class", .drop = FALSE) -> inc_table
# .drop = FALSE not working as expected.  Students with perfect attendance
# not being accounted for with 0 absences.
cur_enr_df %>%
  group_by(Student) %>%
  filter(Presence == "Absent") %>%
  count(name = "Absent", .drop = FALSE) -> abs_table

att_table <-  merge(inc_table, abs_table, by = "Student", all = TRUE) %>% replace_na(replace = list(In_Class = 0, Absent = 0))

perfect <- att_table %>% filter(In_Class == max(att_table$In_Class))
# poor <- att_table %>% filter(In_Class %in% min(att_table$In_Class):(min(att_table$In_Class) + 2))
no_show <- att_table %>% filter(In_Class == 0)

dates <- cur_enr_df$Date %>% unique()
last_two_days <- dates[(length(dates) - 1):length(dates)]
missed_last_two_days <- cur_enr_df %>% filter(Date %in% last_two_days & Presence == "Absent" & !(Student %in% no_show$Student)) %>% group_by(Student) %>% count() %>% filter(n == 2) # %>% select(Student)
```

## Course attendance by student.

### Students with perfect attendance:

`r paste(perfect$Student, collapse = "; ")`

### No shows:

`r paste(no_show$Student, collapse = ";  ")`

### Students who missed the last two class days:

`r paste(missed_last_two_days$Student, collapse = ";  ")`

<!-- \pagebreak -->

## `r header`

## Course attendance by student.


```{r table, echo=FALSE}
# halfway <- ceiling(nrow(att_table)/2)
# kable(list(
#   att_table[1:halfway,],
#   att_table[(halfway + 1):nrow(att_table),]
#   ),
#   booktabs = TRUE, valign = 't'#, align = NULL
#   ) # %>% kable_styling(latex_options = "hold_position")
kable(att_table, booktabs = TRUE, valign = 't', align = NULL)
```
